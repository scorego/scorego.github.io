<!DOCTYPE html>













<html class="theme-next mist" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/uploads/favicon-128x128-01.ico?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon-32x32-01.ico?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon-16x16-01.ico?v=7.1.0">


  <link rel="mask-icon" href="/uploads/favicon-128x128-01.ico?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="ZooKeeper Java ExampleProgramming with ZooKeeper - A basic tutorial - Barrier and Queue TutorialZooKeeper Recipes and Solutions   1. ZooKeeper Java Example A Simple Watch Client   To introduce you to">
<meta name="keywords" content="zookeeper">
<meta property="og:type" content="article">
<meta property="og:title" content="ZooKeeper(四) ZooKeeper Java Example, Recipes and Solutions">
<meta property="og:url" content="javior.wang/2019/04/28/backends/zookeeper/ZooKeeper(四) ZooKeeper Java Example, Recipes and Solutions/index.html">
<meta property="og:site_name" content="Javior&#39;s Blog">
<meta property="og:description" content="ZooKeeper Java ExampleProgramming with ZooKeeper - A basic tutorial - Barrier and Queue TutorialZooKeeper Recipes and Solutions   1. ZooKeeper Java Example A Simple Watch Client   To introduce you to">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-04-28T03:52:25.875Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ZooKeeper(四) ZooKeeper Java Example, Recipes and Solutions">
<meta name="twitter:description" content="ZooKeeper Java ExampleProgramming with ZooKeeper - A basic tutorial - Barrier and Queue TutorialZooKeeper Recipes and Solutions   1. ZooKeeper Java Example A Simple Watch Client   To introduce you to">





  
  
  <link rel="canonical" href="javior.wang/2019/04/28/backends/zookeeper/ZooKeeper(四) ZooKeeper Java Example, Recipes and Solutions/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ZooKeeper(四) ZooKeeper Java Example, Recipes and Solutions | Javior's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Javior's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="javior.wang/2019/04/28/backends/zookeeper/ZooKeeper(四) ZooKeeper Java Example, Recipes and Solutions/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Javior Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Javior's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ZooKeeper(四) ZooKeeper Java Example, Recipes and Solutions

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-28 11:52:35 / 修改时间：11:52:25" itemprop="dateCreated datePublished" datetime="2019-04-28T11:52:35+08:00">2019-04-28</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/zookeeper/" itemprop="url" rel="index"><span itemprop="name">zookeeper</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="https://zookeeper.apache.org/doc/current/javaExample.html" target="_blank" rel="noopener">ZooKeeper Java Example</a><br><a href="https://zookeeper.apache.org/doc/current/zookeeperTutorial.html" target="_blank" rel="noopener">Programming with ZooKeeper - A basic tutorial - Barrier and Queue Tutorial</a><br><a href="https://zookeeper.apache.org/doc/current/recipes.html" target="_blank" rel="noopener">ZooKeeper Recipes and Solutions</a>  </p>
<h2 id="1-ZooKeeper-Java-Example"><a href="#1-ZooKeeper-Java-Example" class="headerlink" title="1. ZooKeeper Java Example"></a>1. ZooKeeper Java Example</h2><p><center> <strong>A Simple Watch Client</strong>  </center></p>
<p>To introduce you to the ZooKeeper Java API, we develop here a very simple watch client. This ZooKeeper client watches a ZooKeeper node for changes and responds to by starting or stopping a program.  </p>
<ul>
<li>Requirements<br>客户端有以下需求：  <ol>
<li>It takes as parameters:   <ul>
<li>the address of the ZooKeeper service</li>
<li>the name of a znode - the one to be watched</li>
<li>the name of a file to write the output to</li>
<li>an executable with arguments.</li>
</ul>
</li>
<li>It fetches the data associated with the znode and starts the executable.</li>
<li>If the znode changes, the client refetches the contents and restarts the executable.</li>
<li>If the znode disappears, the client kills the executable.</li>
</ol>
</li>
<li>Program Design<br>传统上，ZooKeeper应用程序分为两个单元：一个负责维护连接，另一个负责监控数据。在这个示例程序中，<code>Executor</code>类维护ZooKeeper连接，<code>DataMonitor</code>类监视ZooKeeper树中的数据。此外，<code>Executor</code>包含主线程和执行逻辑。它负责用户交互和作为参数传入的可执行程序的交互，以及根据znode的状态(根据需求)关闭和重新启动该示例程序。  </li>
</ul>
<h3 id="1-1-The-Executor-Class"><a href="#1-1-The-Executor-Class" class="headerlink" title="1.1 The Executor Class"></a>1.1 The <code>Executor</code> Class</h3><p><code>Executor</code>对象是示例应用程序的主要容器。它同时包含ZooKeeper对象和<code>DataMonitor</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// from the Executor class...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (args.length &lt; <span class="number">4</span>) &#123;</span><br><span class="line">        System.err.println(<span class="string">"USAGE: Executor hostPort znode filename program [args ...]"</span>);</span><br><span class="line">        System.exit(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    String hostPort = args[<span class="number">0</span>];</span><br><span class="line">    String znode = args[<span class="number">1</span>];</span><br><span class="line">    String filename = args[<span class="number">2</span>];</span><br><span class="line">    String exec[] = <span class="keyword">new</span> String[args.length - <span class="number">3</span>];</span><br><span class="line">    System.arraycopy(args, <span class="number">3</span>, exec, <span class="number">0</span>, exec.length);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> Executor(hostPort, znode, filename, exec).run();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Executor</span><span class="params">(String hostPort, String znode, String filename,</span></span></span><br><span class="line"><span class="function"><span class="params">        String exec[])</span> <span class="keyword">throws</span> KeeperException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.filename = filename;</span><br><span class="line">    <span class="keyword">this</span>.exec = exec;</span><br><span class="line">    zk = <span class="keyword">new</span> ZooKeeper(hostPort, <span class="number">3000</span>, <span class="keyword">this</span>);</span><br><span class="line">    dm = <span class="keyword">new</span> DataMonitor(zk, znode, <span class="keyword">null</span>, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (!dm.dead) &#123;</span><br><span class="line">                wait();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>回想一下，<code>Executor</code>的任务是启动和停止在命令行中传递其名称的可执行程序。它这样做是为了响应ZooKeeper对象触发的事件。如上述代码所示，<code>Executor</code>在ZooKeeper构造函数中传递自己的引用作为<code>Watcher</code>参数。它还将自己的引用作为<code>DataMonitorListener</code>参数的引用传递给<code>DataMonitor</code>构造函数。根据<code>Executor</code>的定义，它实现了这两个接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Executor</span> <span class="keyword">implements</span> <span class="title">Watcher</span>, <span class="title">Runnable</span>, <span class="title">DataMonitor</span>.<span class="title">DataMonitorListener</span> </span>&#123;</span><br></pre></td></tr></table></figure></p>
<p><code>Watcher</code>接口是由ZooKeeper Java API定义的，ZK使用它来与它的容器通信。它只支持一个方法<code>process()</code>， ZooKeeper使用它来共享主线程感兴趣的一般事件，比如ZooKeeper连接或ZooKeeper会话的状态。本例中的<code>Executor</code>只是简单地将这些事件转发给<code>DataMonitor</code>来决定如何处理它们。这样做只是为了说明，按照惯例，<code>Executor</code>或一些类似于<code>Executor</code>的对象“拥有”ZooKeeper连接，但是可以自由地将事件委托给其他事件或对象。它还将此作为触发监视事件的默认通道。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">    dm.process(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>另一方面，<code>DataMonitorListener</code>接口不是ZooKeeper API的一部分。它是一个这个示例程序完全自定义的接口。<code>DataMonitor</code>对象使用它与容器通信，容器也是<code>Executor</code>对象。<code>DataMonitorListener</code>接口是这样的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataMonitorListener</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The existence status of the node has changed.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exists</span><span class="params">(<span class="keyword">byte</span> data[])</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The ZooKeeper session is no longer valid.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> rc</span></span><br><span class="line"><span class="comment">    * the ZooKeeper reason code</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">closing</span><span class="params">(<span class="keyword">int</span> rc)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个接口在<code>DataMonitor</code>类中定义，并在<code>Executor</code>类中实现。当调用<code>Executor.exists()</code>时，<code>Executor</code>根据需求决定是启动还是关闭。回想一下，一旦znode不<code>exist</code>，需求是要关闭可执行程序。<br>当调用<code>Executor.closing()</code>时，<code>Executor</code>决定是否关闭自己，以响应ZooKeeper连接永久消失。<br><code>DataMonitor</code>对象也是调用这些方法以响应ZooKeeper状态的更改。<br>下面是<code>Executor</code>关于<code>DataMonitorListener.exists()</code>和<code>DataMonitorListener.closing</code>的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exists</span><span class="params">( <span class="keyword">byte</span>[] data )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Killing process"</span>);</span><br><span class="line">            child.destroy();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                child.waitFor();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        child = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Stopping child"</span>);</span><br><span class="line">            child.destroy();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               child.waitFor();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(filename);</span><br><span class="line">            fos.write(data);</span><br><span class="line">            fos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"Starting child"</span>);</span><br><span class="line">            child = Runtime.getRuntime().exec(exec);</span><br><span class="line">            <span class="keyword">new</span> StreamWriter(child.getInputStream(), System.out);</span><br><span class="line">            <span class="keyword">new</span> StreamWriter(child.getErrorStream(), System.err);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closing</span><span class="params">(<span class="keyword">int</span> rc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="1-2-The-DataMonitor-Class"><a href="#1-2-The-DataMonitor-Class" class="headerlink" title="1.2 The DataMonitor Class"></a>1.2 The DataMonitor Class</h3><p><code>DataMonitor</code>类具有ZooKeeper逻辑的精华。它主要是异步和事件驱动的。<code>DataMonitor</code>在构造函数中开始:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DataMonitor</span><span class="params">(ZooKeeper zk, String znode, Watcher chainedWatcher,</span></span></span><br><span class="line"><span class="function"><span class="params">        DataMonitorListener listener)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.zk = zk;</span><br><span class="line">    <span class="keyword">this</span>.znode = znode;</span><br><span class="line">    <span class="keyword">this</span>.chainedWatcher = chainedWatcher;</span><br><span class="line">    <span class="keyword">this</span>.listener = listener;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get things started by checking if the node exists. We are going</span></span><br><span class="line">    <span class="comment">// to be completely event driven</span></span><br></pre></td></tr></table></figure></p>
<p>对<code>ZooKeeper.exists()</code>的调用检查znode的存在性、设置一个<code>watch</code>，并将对自身的引用作为completion回调对象传递。从这个意义上说，它开启了一切，因为真正的进程发生在<code>watch</code>被触发时。  </p>
<blockquote>
<p>Don’t confuse the completion callback with the watch callback. The <code>ZooKeeper.exists()</code> completion callback, which happens to be the method <code>StatCallback.processResult()</code> implemented in the <code>DataMonitor</code> object, is invoked when the asynchronous setting of the watch operation (by <code>ZooKeeper.exists()</code>) completes on the server.<br>The triggering of the <code>watch</code>, on the other hand, sends an event to the <code>Executor</code> object, since the <code>Executor</code> registered as the <code>Watcher</code> of the ZooKeeper object.<br>As an aside, you might note that the <code>DataMonitor</code> could also register itself as the <code>Watcher</code> for this particular watch event. This is new to ZooKeeper 3.0.0 (the support of multiple Watchers). In this example, however, <code>DataMonitor</code> does not register as the <code>Watcher</code>.   </p>
</blockquote>
<p>当<code>ZooKeeper.exists()</code>操作在服务器上完成时，ZooKeeper API在客户端调用这个完成回调:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx, Stat stat)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> exists;</span><br><span class="line">    <span class="keyword">switch</span> (rc) &#123;</span><br><span class="line">    <span class="keyword">case</span> Code.Ok:</span><br><span class="line">        exists = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Code.NoNode:</span><br><span class="line">        exists = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Code.SessionExpired:</span><br><span class="line">    <span class="keyword">case</span> Code.NoAuth:</span><br><span class="line">        dead = <span class="keyword">true</span>;</span><br><span class="line">        listener.closing(rc);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// Retry errors</span></span><br><span class="line">        zk.exists(znode, <span class="keyword">true</span>, <span class="keyword">this</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span> b[] = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (exists) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            b = zk.getData(znode, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">            <span class="comment">// We don't need to worry about recovering now. The watch</span></span><br><span class="line">            <span class="comment">// callbacks will kick off any exception handling</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;     </span><br><span class="line">    <span class="keyword">if</span> ((b == <span class="keyword">null</span> &amp;amp;&amp;amp; b != prevData)</span><br><span class="line">        || (b != <span class="keyword">null</span> &amp;amp;&amp;amp; !Arrays.equals(prevData, b))) &#123;</span><br><span class="line">        listener.exists(b);&lt;/emphasis&gt;</span><br><span class="line">        prevData = b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该代码首先检查错误码，以查看znode是否存在、致命的错误和可恢复错误。如果文件(或znode)存在，它将从znode获取数据，然后在状态发生更改时调用<code>Executor</code>的<code>exists()</code>回调函数。注意，它不必对<code>getData</code>调用执行任何异常处理，因为它对任何可能导致错误的东西都有<code>watch</code>:如果在调用<code>ZooKeeper.getData()</code>之前删除了节点，则由<code>ZooKeeper.exists()</code>设置的监视事件将触发回调;如果存在通信错误，当连接重新启动时连接监视事件将触发。<br>Finally, notice how <code>DataMonitor</code> processes watch events:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">    String path = event.getPath();</span><br><span class="line">    <span class="keyword">if</span> (event.getType() == Event.EventType.None) &#123;</span><br><span class="line">        <span class="comment">// We are are being told that the state of the</span></span><br><span class="line">        <span class="comment">// connection has changed</span></span><br><span class="line">        <span class="keyword">switch</span> (event.getState()) &#123;</span><br><span class="line">        <span class="keyword">case</span> SyncConnected:</span><br><span class="line">            <span class="comment">// In this particular example we don't need to do anything</span></span><br><span class="line">            <span class="comment">// here - watches are automatically re-registered with</span></span><br><span class="line">            <span class="comment">// server and any watches triggered while the client was</span></span><br><span class="line">            <span class="comment">// disconnected will be delivered (in order of course)</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Expired:</span><br><span class="line">            <span class="comment">// It's all over</span></span><br><span class="line">            dead = <span class="keyword">true</span>;</span><br><span class="line">            listener.closing(KeeperException.Code.SessionExpired);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (path != <span class="keyword">null</span> &amp;&amp; path.equals(znode)) &#123;</span><br><span class="line">            <span class="comment">// Something has changed on the node, let's find out</span></span><br><span class="line">            zk.exists(znode, <span class="keyword">true</span>, <span class="keyword">this</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (chainedWatcher != <span class="keyword">null</span>) &#123;</span><br><span class="line">        chainedWatcher.process(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果客户端侧的ZooKeeper库可以在会话过期(过期事件)之前重新建立与ZooKeeper的通信通道(SyncConnected event)，则会话的所有<code>watch</code>将自动与服务器一起重新建立(ZooKeeper 3.0.0中新增了自动重置<code>watch</code>功能)。当<code>DataMonitor</code>为znode获取一个事件时，它调用<code>ZooKeeper.exists()</code>来找出发生了什么变化。  </p>
<h3 id="1-3-Complete-Source-Listings"><a href="#1-3-Complete-Source-Listings" class="headerlink" title="1.3 Complete Source Listings"></a>1.3 Complete Source Listings</h3><p><strong><code>Executor.java</code></strong>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A simple example program to use DataMonitor to start and</span></span><br><span class="line"><span class="comment"> * stop executables based on a znode. The program watches the</span></span><br><span class="line"><span class="comment"> * specified znode and saves the data that corresponds to the</span></span><br><span class="line"><span class="comment"> * znode in the filesystem. It also starts the specified program</span></span><br><span class="line"><span class="comment"> * with the specified arguments when the znode exists and kills</span></span><br><span class="line"><span class="comment"> * the program if the znode goes away.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.KeeperException;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.WatchedEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.Watcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooKeeper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Executor</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Watcher</span>, <span class="title">Runnable</span>, <span class="title">DataMonitor</span>.<span class="title">DataMonitorListener</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    String znode;</span><br><span class="line">    DataMonitor dm;</span><br><span class="line">    ZooKeeper zk;</span><br><span class="line">    String filename;</span><br><span class="line">    String exec[];</span><br><span class="line">    Process child;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Executor</span><span class="params">(String hostPort, String znode, String filename,</span></span></span><br><span class="line"><span class="function"><span class="params">            String exec[])</span> <span class="keyword">throws</span> KeeperException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.filename = filename;</span><br><span class="line">        <span class="keyword">this</span>.exec = exec;</span><br><span class="line">        zk = <span class="keyword">new</span> ZooKeeper(hostPort, <span class="number">3000</span>, <span class="keyword">this</span>);</span><br><span class="line">        dm = <span class="keyword">new</span> DataMonitor(zk, znode, <span class="keyword">null</span>, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (args.length &lt; <span class="number">4</span>) &#123;</span><br><span class="line">            System.err</span><br><span class="line">                    .println(<span class="string">"USAGE: Executor hostPort znode filename program [args ...]"</span>);</span><br><span class="line">            System.exit(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String hostPort = args[<span class="number">0</span>];</span><br><span class="line">        String znode = args[<span class="number">1</span>];</span><br><span class="line">        String filename = args[<span class="number">2</span>];</span><br><span class="line">        String exec[] = <span class="keyword">new</span> String[args.length - <span class="number">3</span>];</span><br><span class="line">        System.arraycopy(args, <span class="number">3</span>, exec, <span class="number">0</span>, exec.length);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> Executor(hostPort, znode, filename, exec).run();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***************************************************************************</span></span><br><span class="line"><span class="comment">     * We do process any events ourselves, we just need to forward them on.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.apache.zookeeper.Watcher#process(org.apache.zookeeper.proto.WatcherEvent)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">        dm.process(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">while</span> (!dm.dead) &#123;</span><br><span class="line">                    wait();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closing</span><span class="params">(<span class="keyword">int</span> rc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamWriter</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        OutputStream os;</span><br><span class="line"></span><br><span class="line">        InputStream is;</span><br><span class="line"></span><br><span class="line">        StreamWriter(InputStream is, OutputStream os) &#123;</span><br><span class="line">            <span class="keyword">this</span>.is = is;</span><br><span class="line">            <span class="keyword">this</span>.os = os;</span><br><span class="line">            start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">byte</span> b[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">80</span>];</span><br><span class="line">            <span class="keyword">int</span> rc;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> ((rc = is.read(b)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    os.write(b, <span class="number">0</span>, rc);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exists</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Killing process"</span>);</span><br><span class="line">                child.destroy();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    child.waitFor();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            child = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Stopping child"</span>);</span><br><span class="line">                child.destroy();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    child.waitFor();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(filename);</span><br><span class="line">                fos.write(data);</span><br><span class="line">                fos.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"Starting child"</span>);</span><br><span class="line">                child = Runtime.getRuntime().exec(exec);</span><br><span class="line">                <span class="keyword">new</span> StreamWriter(child.getInputStream(), System.out);</span><br><span class="line">                <span class="keyword">new</span> StreamWriter(child.getErrorStream(), System.err);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong><code>DataMonitor.java</code></strong>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A simple class that monitors the data and existence of a ZooKeeper</span></span><br><span class="line"><span class="comment"> * node. It uses asynchronous ZooKeeper APIs.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.KeeperException;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.WatchedEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.Watcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooKeeper;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.AsyncCallback.StatCallback;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.KeeperException.Code;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.data.Stat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataMonitor</span> <span class="keyword">implements</span> <span class="title">Watcher</span>, <span class="title">StatCallback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ZooKeeper zk;</span><br><span class="line">    String znode;</span><br><span class="line">    Watcher chainedWatcher;</span><br><span class="line">    <span class="keyword">boolean</span> dead;</span><br><span class="line">    DataMonitorListener listener;</span><br><span class="line">    <span class="keyword">byte</span> prevData[];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataMonitor</span><span class="params">(ZooKeeper zk, String znode, Watcher chainedWatcher,</span></span></span><br><span class="line"><span class="function"><span class="params">            DataMonitorListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zk = zk;</span><br><span class="line">        <span class="keyword">this</span>.znode = znode;</span><br><span class="line">        <span class="keyword">this</span>.chainedWatcher = chainedWatcher;</span><br><span class="line">        <span class="keyword">this</span>.listener = listener;</span><br><span class="line">        <span class="comment">// Get things started by checking if the node exists. We are going</span></span><br><span class="line">        <span class="comment">// to be completely event driven</span></span><br><span class="line">        zk.exists(znode, <span class="keyword">true</span>, <span class="keyword">this</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Other classes use the DataMonitor by implementing this method</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataMonitorListener</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The existence status of the node has changed.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">exists</span><span class="params">(<span class="keyword">byte</span> data[])</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The ZooKeeper session is no longer valid.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> rc</span></span><br><span class="line"><span class="comment">         *                the ZooKeeper reason code</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">closing</span><span class="params">(<span class="keyword">int</span> rc)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">        String path = event.getPath();</span><br><span class="line">        <span class="keyword">if</span> (event.getType() == Event.EventType.None) &#123;</span><br><span class="line">            <span class="comment">// We are are being told that the state of the</span></span><br><span class="line">            <span class="comment">// connection has changed</span></span><br><span class="line">            <span class="keyword">switch</span> (event.getState()) &#123;</span><br><span class="line">            <span class="keyword">case</span> SyncConnected:</span><br><span class="line">                <span class="comment">// In this particular example we don't need to do anything</span></span><br><span class="line">                <span class="comment">// here - watches are automatically re-registered with</span></span><br><span class="line">                <span class="comment">// server and any watches triggered while the client was</span></span><br><span class="line">                <span class="comment">// disconnected will be delivered (in order of course)</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Expired:</span><br><span class="line">                <span class="comment">// It's all over</span></span><br><span class="line">                dead = <span class="keyword">true</span>;</span><br><span class="line">                listener.closing(KeeperException.Code.SessionExpired);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (path != <span class="keyword">null</span> &amp;&amp; path.equals(znode)) &#123;</span><br><span class="line">                <span class="comment">// Something has changed on the node, let's find out</span></span><br><span class="line">                zk.exists(znode, <span class="keyword">true</span>, <span class="keyword">this</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (chainedWatcher != <span class="keyword">null</span>) &#123;</span><br><span class="line">            chainedWatcher.process(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx, Stat stat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> exists;</span><br><span class="line">        <span class="keyword">switch</span> (rc) &#123;</span><br><span class="line">        <span class="keyword">case</span> Code.Ok:</span><br><span class="line">            exists = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Code.NoNode:</span><br><span class="line">            exists = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Code.SessionExpired:</span><br><span class="line">        <span class="keyword">case</span> Code.NoAuth:</span><br><span class="line">            dead = <span class="keyword">true</span>;</span><br><span class="line">            listener.closing(rc);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// Retry errors</span></span><br><span class="line">            zk.exists(znode, <span class="keyword">true</span>, <span class="keyword">this</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span> b[] = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (exists) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                b = zk.getData(znode, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">                <span class="comment">// We don't need to worry about recovering now. The watch</span></span><br><span class="line">                <span class="comment">// callbacks will kick off any exception handling</span></span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((b == <span class="keyword">null</span> &amp;&amp; b != prevData)</span><br><span class="line">                || (b != <span class="keyword">null</span> &amp;&amp; !Arrays.equals(prevData, b))) &#123;</span><br><span class="line">            listener.exists(b);</span><br><span class="line">            prevData = b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-Programming-with-ZooKeeper-A-basic-tutorial"><a href="#2-Programming-with-ZooKeeper-A-basic-tutorial" class="headerlink" title="2. Programming with ZooKeeper - A basic tutorial"></a>2. Programming with ZooKeeper - A basic tutorial</h2><p>In this tutorial, we show simple implementations of barriers and producer-consumer queues using ZooKeeper. We call the respective classes <code>Barrier</code> and <code>Queue</code>. These examples assume that you have at least one ZooKeeper server running.<br>这两个原语都引用以下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ZooKeeper zk = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">static</span> Integer mutex;</span><br><span class="line"></span><br><span class="line">String root;</span><br><span class="line"></span><br><span class="line">SyncPrimitive(String address) &#123;</span><br><span class="line">    <span class="keyword">if</span>(zk == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"Starting ZK:"</span>);</span><br><span class="line">            zk = <span class="keyword">new</span> ZooKeeper(address, <span class="number">3000</span>, <span class="keyword">this</span>);</span><br><span class="line">            mutex = <span class="keyword">new</span> Integer(-<span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">"Finished starting ZK: "</span> + zk);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(e.toString());</span><br><span class="line">            zk = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">        mutex.notify();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这两个类都继承了<code>SyncPrimitive</code>。通过这种方式，我们可以执行<code>SyncPrimitive</code>构造函数中有共有步骤的原语。为了保持示例的简单性，我们在第一次实例化<code>barrier</code>对象或<code>queue</code>对象时创建一个<code>ZooKeeper</code>对象，并声明一个静态变量引用该对象。<code>Barrier</code>和<code>Queue</code>的后续实例会先检查<code>ZooKeeper</code>对象是否存在。或者，我们可以让应用程序创建一个<code>ZooKeeper</code>对象，并将其传递给<code>Barrier</code>和<code>Queue</code>的构造函数。<br>我们使用<code>process()</code>方法来处理watches触发的通知。在接下来的讨论中，我们将介绍设置watch的代码。watch是一种内部结构，允许ZooKeeper将节点的更改通知给客户端。例如，如果一个客户端正在等待其他客户端离开一个<code>barrier</code>，那么它可以设置一个watch并等待特定节点的修改，这个修改表示结束等待。  </p>
<h3 id="2-1-Barriers"><a href="#2-1-Barriers" class="headerlink" title="2.1 Barriers"></a>2.1 Barriers</h3><p><code>barrier</code>是一个原语，它使一组进程能够同步计算的开始和结束。该实现的总体思想是拥有一个<code>barrier</code>节点，它的作用是作为独立的进程节点的父节点。假设我们称barrier node 为<code>/b1</code>。每个进程<code>p</code>创建一个节点<code>/b1/p</code>。一旦足够多的进程创建了相应的节点，参与的进程就可以开始计算。<br>在这个例子中，每个进程实例化一个<code>Barrier</code>对象，它的构造函数参数是:</p>
<ul>
<li>the address of a ZooKeeper server (e.g., “zoo1.foo.com:2181”)</li>
<li>the path of the barrier node on ZooKeeper (e.g., “/b1”)</li>
<li>the size of the group of processes  </li>
</ul>
<p><code>Barrier</code>的构造函数将Zookeeper服务器的地址传递给父类的构造函数。如果ZooKeeper实例不存在，父类将创建该实例。然后<code>Barrier</code>的构造函数在ZooKeeper上创建一个barrier node，它是所有进程节点的父节点，我们称之为根<code>root</code>(<strong>注意:</strong> 这不是ZooKeeper的根节点<code>/</code>)。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Barrier constructor</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> address</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> root</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> size</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Barrier(String address, String root, <span class="keyword">int</span> size) &#123;</span><br><span class="line">    <span class="keyword">super</span>(address);</span><br><span class="line">    <span class="keyword">this</span>.root = root;</span><br><span class="line">    <span class="keyword">this</span>.size = size;</span><br><span class="line">    <span class="comment">// Create barrier node</span></span><br><span class="line">    <span class="keyword">if</span> (zk != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Stat s = zk.exists(root, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                zk.create(root, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>], Ids.OPEN_ACL_UNSAFE,</span><br><span class="line">                        CreateMode.PERSISTENT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">            System.out</span><br><span class="line">                    .println(<span class="string">"Keeper exception when instantiating queue: "</span></span><br><span class="line">                            + e.toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Interrupted exception"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// My node name</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        name = <span class="keyword">new</span> String(InetAddress.getLocalHost().getCanonicalHostName().toString());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">        System.out.println(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>要进入barrier，进程要调用<code>enter()</code>。进程在根下创建一个节点来表示自己，并使用自己的主机名来给节点命名。然后等待足够多的进程进入barrier。一个进程通过使用<code>getChildren()</code>检查根节点的子节点数来执行此操作，并在没有足球的情况下等待通知。要在根节点发生更改时接收通知，流程必须设置一个watch，并通过调用<code>getChildren()</code>来完成。在代码中，<code>getChildren()</code>有两个参数。第一个声明要读取的节点，第二个是一个布尔值标志来设置一个手表。在代码中，标志为true。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Join barrier</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> KeeperException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">enter</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException</span>&#123;</span><br><span class="line">    zk.create(root + <span class="string">"/"</span> + name, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>], Ids.OPEN_ACL_UNSAFE,</span><br><span class="line">            CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">            List&lt;String&gt; list = zk.getChildren(root, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (list.size() &lt; size) &#123;</span><br><span class="line">                mutex.wait();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Note that <code>enter()</code> throws both <code>KeeperException</code> and <code>InterruptedException</code>, so it is the responsibility of the application to catch and handle such exceptions.  </p>
</blockquote>
<p>一旦计算完成，进程调用<code>leave()</code>来离开barrier。首先删除对应的节点，然后获取根节点的子节点列表。如果至少有一个子节点，那么它将等待一个通知(obs:注意，调用<code>getChildren()</code>的第二个参数为true，这意味着ZooKeeper必须在根节点上设置一个手表)。在接收到通知后，它将再次检查根节点是否有任何子节点。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Wait until all reach barrier</span><br><span class="line"> *</span><br><span class="line"> * @return</span><br><span class="line"> * @throws KeeperException</span><br><span class="line"> * @throws InterruptedException</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">boolean leave() throws KeeperException, InterruptedException &#123;</span><br><span class="line">    zk.delete(root + &quot;/&quot; + name, 0);</span><br><span class="line">    while (true) &#123;</span><br><span class="line">        synchronized (mutex) &#123;</span><br><span class="line">            List&lt;String&gt; list = zk.getChildren(root, true);</span><br><span class="line">                if (list.size() &gt; 0) &#123;</span><br><span class="line">                    mutex.wait();</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-2-Producer-Consumer-Queues"><a href="#2-2-Producer-Consumer-Queues" class="headerlink" title="2.2 Producer-Consumer Queues"></a>2.2 Producer-Consumer Queues</h3><p>生产者-消费者队列是一种分布式数据结构，进程组使用它来生产和消费东西。生产者进程创建新元素并将它们添加到队列中。消费者进程从列表中删除元素并处理它们。在这个实现中，元素是简单的整数。队列由根节点表示，为了向队列添加元素，生产者进程创建一个新节点，即根节点的一个子节点。<br>下面的代码摘录对应于对象的构造函数。与<code>Barrier</code>对象一样，它首先调用父类<code>SyncPrimitive</code>的构造函数，如果<code>ZooKeeper</code>对象不存在，这个构造函数将创建一个<code>ZooKeeper</code>对象。然后，它验证队列的根节点是否存在，如果不存在，则创建根节点。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Constructor of producer-consumer queue</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> address</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Queue(String address, String name) &#123;</span><br><span class="line">    <span class="keyword">super</span>(address);</span><br><span class="line">    <span class="keyword">this</span>.root = name;</span><br><span class="line">    <span class="comment">// Create ZK node name</span></span><br><span class="line">    <span class="keyword">if</span> (zk != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Stat s = zk.exists(root, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                zk.create(root, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>], Ids.OPEN_ACL_UNSAFE,</span><br><span class="line">                        CreateMode.PERSISTENT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">            System.out</span><br><span class="line">                    .println(<span class="string">"Keeper exception when instantiating queue: "</span></span><br><span class="line">                            + e.toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Interrupted exception"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>生产者进程调用<code>generate()</code>向队列添加一个元素，并传递一个整数作为参数。要向队列添加元素，该方法使用<code>create()</code>创建一个新节点，并使用<code>SEQUENCE</code>标志指示ZooKeeper追加与根节点关联的序列计数器的值。这样，我们对队列的元素强制追加一个顺序，从而确保队列中最老的元素是下一个使用的元素。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add element to the queue.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> i</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">produce</span><span class="params">(<span class="keyword">int</span> i)</span> <span class="keyword">throws</span> KeeperException, InterruptedException</span>&#123;</span><br><span class="line">    ByteBuffer b = ByteBuffer.allocate(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">byte</span>[] value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add child with value i</span></span><br><span class="line">    b.putInt(i);</span><br><span class="line">    value = b.array();</span><br><span class="line">    zk.create(root + <span class="string">"/element"</span>, value, Ids.OPEN_ACL_UNSAFE,</span><br><span class="line">                CreateMode.PERSISTENT_SEQUENTIAL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>要使用元素，消费者进程获取根节点的子节点，读取计数器值最小的节点，并返回元素。注意，如果存在冲突，那么两个竞争进程中的一个将无法删除节点，<code>delete</code>操作将抛出异常。<br>调用<code>getChildren()</code>以字典顺序返回子列表。由于字典顺序不需要遵循计数器值的数值顺序，所以我们需要确定哪个元素是最小的。为了确定哪个计数器值最小，我们遍历列表，并删除前缀<code>element</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Remove first element from the queue.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> KeeperException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">consume</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException</span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retvalue = -<span class="number">1</span>;</span><br><span class="line">    Stat stat = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the first element available</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">            List&lt;String&gt; list = zk.getChildren(root, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (list.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Going to wait"</span>);</span><br><span class="line">                mutex.wait();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Integer min = <span class="keyword">new</span> Integer(list.get(<span class="number">0</span>).substring(<span class="number">7</span>));</span><br><span class="line">                <span class="keyword">for</span>(String s : list)&#123;</span><br><span class="line">                    Integer tempValue = <span class="keyword">new</span> Integer(s.substring(<span class="number">7</span>));</span><br><span class="line">                    <span class="comment">//System.out.println("Temporary value: " + tempValue);</span></span><br><span class="line">                    <span class="keyword">if</span>(tempValue &lt; min) min = tempValue;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"Temporary value: "</span> + root + <span class="string">"/element"</span> + min);</span><br><span class="line">                <span class="keyword">byte</span>[] b = zk.getData(root + <span class="string">"/element"</span> + min,</span><br><span class="line">                            <span class="keyword">false</span>, stat);</span><br><span class="line">                zk.delete(root + <span class="string">"/element"</span> + min, <span class="number">0</span>);</span><br><span class="line">                ByteBuffer buffer = ByteBuffer.wrap(b);</span><br><span class="line">                retvalue = buffer.getInt();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> retvalue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-3-Complete-example"><a href="#2-3-Complete-example" class="headerlink" title="2.3 Complete example"></a>2.3 Complete example</h3><p>使用下述命令运行示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ZOOBINDIR=&quot;[path_to_distro]/bin&quot;</span><br><span class="line">. &quot;$ZOOBINDIR&quot;/zkEnv.sh</span><br><span class="line">java SyncPrimitive [Test Type] [ZK server] [No of elements] [Client type]</span><br></pre></td></tr></table></figure></p>
<h4 id="2-3-1-Queue-test"><a href="#2-3-1-Queue-test" class="headerlink" title="2.3.1 Queue test"></a>2.3.1 Queue test</h4><p>Start a producer to create 100 elements:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java SyncPrimitive qTest localhost 100 p</span><br></pre></td></tr></table></figure></p>
<p>Start a consumer to consume 100 elements:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java SyncPrimitive qTest localhost 100 c</span><br></pre></td></tr></table></figure></p>
<h4 id="2-3-2-Barrier-test"><a href="#2-3-2-Barrier-test" class="headerlink" title="2.3.2 Barrier test"></a>2.3.2 Barrier test</h4><p>用2个参与者开始一个barrier(你想几倍参与者就运行几次):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java SyncPrimitive bTest localhost 2</span><br></pre></td></tr></table></figure></p>
<h4 id="2-3-3-Source-Listing"><a href="#2-3-3-Source-Listing" class="headerlink" title="2.3.3 Source Listing"></a>2.3.3 Source Listing</h4><p><code>SyncPrimitive.Java</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.UnknownHostException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.CreateMode;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.KeeperException;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.WatchedEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.Watcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooKeeper;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooDefs.Ids;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.data.Stat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncPrimitive</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> ZooKeeper zk = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">static</span> Integer mutex;</span><br><span class="line">    String root;</span><br><span class="line"></span><br><span class="line">    SyncPrimitive(String address) &#123;</span><br><span class="line">        <span class="keyword">if</span>(zk == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"Starting ZK:"</span>);</span><br><span class="line">                zk = <span class="keyword">new</span> ZooKeeper(address, <span class="number">3000</span>, <span class="keyword">this</span>);</span><br><span class="line">                mutex = <span class="keyword">new</span> Integer(-<span class="number">1</span>);</span><br><span class="line">                System.out.println(<span class="string">"Finished starting ZK: "</span> + zk);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                System.out.println(e.toString());</span><br><span class="line">                zk = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//else mutex = new Integer(-1);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">            <span class="comment">//System.out.println("Process: " + event.getType());</span></span><br><span class="line">            mutex.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Barrier</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Barrier</span> <span class="keyword">extends</span> <span class="title">SyncPrimitive</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> size;</span><br><span class="line">        String name;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Barrier constructor</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> address</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> root</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> size</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Barrier(String address, String root, <span class="keyword">int</span> size) &#123;</span><br><span class="line">            <span class="keyword">super</span>(address);</span><br><span class="line">            <span class="keyword">this</span>.root = root;</span><br><span class="line">            <span class="keyword">this</span>.size = size;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create barrier node</span></span><br><span class="line">            <span class="keyword">if</span> (zk != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Stat s = zk.exists(root, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        zk.create(root, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>], Ids.OPEN_ACL_UNSAFE,</span><br><span class="line">                                CreateMode.PERSISTENT);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">                    System.out</span><br><span class="line">                            .println(<span class="string">"Keeper exception when instantiating queue: "</span></span><br><span class="line">                                    + e.toString());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"Interrupted exception"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// My node name</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                name = <span class="keyword">new</span> String(InetAddress.getLocalHost().getCanonicalHostName().toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">                System.out.println(e.toString());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Join barrier</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> KeeperException</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">enter</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException</span>&#123;</span><br><span class="line">            zk.create(root + <span class="string">"/"</span> + name, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>], Ids.OPEN_ACL_UNSAFE,</span><br><span class="line">                    CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">                    List&lt;String&gt; list = zk.getChildren(root, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (list.size() &lt; size) &#123;</span><br><span class="line">                        mutex.wait();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Wait until all reach barrier</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> KeeperException</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">leave</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException</span>&#123;</span><br><span class="line">            zk.delete(root + <span class="string">"/"</span> + name, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">                    List&lt;String&gt; list = zk.getChildren(root, <span class="keyword">true</span>);</span><br><span class="line">                        <span class="keyword">if</span> (list.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            mutex.wait();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Producer-Consumer queue</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Queue</span> <span class="keyword">extends</span> <span class="title">SyncPrimitive</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Constructor of producer-consumer queue</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> address</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Queue(String address, String name) &#123;</span><br><span class="line">            <span class="keyword">super</span>(address);</span><br><span class="line">            <span class="keyword">this</span>.root = name;</span><br><span class="line">            <span class="comment">// Create ZK node name</span></span><br><span class="line">            <span class="keyword">if</span> (zk != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Stat s = zk.exists(root, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        zk.create(root, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>], Ids.OPEN_ACL_UNSAFE,</span><br><span class="line">                                CreateMode.PERSISTENT);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">                    System.out</span><br><span class="line">                            .println(<span class="string">"Keeper exception when instantiating queue: "</span></span><br><span class="line">                                    + e.toString());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"Interrupted exception"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Add element to the queue.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> i</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">produce</span><span class="params">(<span class="keyword">int</span> i)</span> <span class="keyword">throws</span> KeeperException, InterruptedException</span>&#123;</span><br><span class="line">            ByteBuffer b = ByteBuffer.allocate(<span class="number">4</span>);</span><br><span class="line">            <span class="keyword">byte</span>[] value;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add child with value i</span></span><br><span class="line">            b.putInt(i);</span><br><span class="line">            value = b.array();</span><br><span class="line">            zk.create(root + <span class="string">"/element"</span>, value, Ids.OPEN_ACL_UNSAFE,</span><br><span class="line">                        CreateMode.PERSISTENT_SEQUENTIAL);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Remove first element from the queue.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> KeeperException</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">int</span> <span class="title">consume</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException</span>&#123;</span><br><span class="line">            <span class="keyword">int</span> retvalue = -<span class="number">1</span>;</span><br><span class="line">            Stat stat = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get the first element available</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">                    List&lt;String&gt; list = zk.getChildren(root, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> (list.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                        System.out.println(<span class="string">"Going to wait"</span>);</span><br><span class="line">                        mutex.wait();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Integer min = <span class="keyword">new</span> Integer(list.get(<span class="number">0</span>).substring(<span class="number">7</span>));</span><br><span class="line">                        String minNode = list.get(<span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">for</span>(String s : list)&#123;</span><br><span class="line">                            Integer tempValue = <span class="keyword">new</span> Integer(s.substring(<span class="number">7</span>));</span><br><span class="line">                            <span class="comment">//System.out.println("Temporary value: " + tempValue);</span></span><br><span class="line">                            <span class="keyword">if</span>(tempValue &lt; min) &#123;</span><br><span class="line">                                min = tempValue;</span><br><span class="line">                                minNode = s;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        System.out.println(<span class="string">"Temporary value: "</span> + root + <span class="string">"/"</span> + minNode);</span><br><span class="line">                        <span class="keyword">byte</span>[] b = zk.getData(root + <span class="string">"/"</span> + minNode,</span><br><span class="line">                        <span class="keyword">false</span>, stat);</span><br><span class="line">                        zk.delete(root + <span class="string">"/"</span> + minNode, <span class="number">0</span>);</span><br><span class="line">                        ByteBuffer buffer = ByteBuffer.wrap(b);</span><br><span class="line">                        retvalue = buffer.getInt();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> retvalue;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (args[<span class="number">0</span>].equals(<span class="string">"qTest"</span>))</span><br><span class="line">            queueTest(args);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            barrierTest(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">queueTest</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        Queue q = <span class="keyword">new</span> Queue(args[<span class="number">1</span>], <span class="string">"/app1"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"Input: "</span> + args[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        Integer max = <span class="keyword">new</span> Integer(args[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (args[<span class="number">3</span>].equals(<span class="string">"p"</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Producer"</span>);</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; max; i++)</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    q.produce(<span class="number">10</span> + i);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (KeeperException e)&#123;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"Consumer"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; max; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">int</span> r = q.consume();</span><br><span class="line">                    System.out.println(<span class="string">"Item: "</span> + r);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (KeeperException e)&#123;</span><br><span class="line">                    i--;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">barrierTest</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        Barrier b = <span class="keyword">new</span> Barrier(args[<span class="number">1</span>], <span class="string">"/b1"</span>, <span class="keyword">new</span> Integer(args[<span class="number">2</span>]));</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">boolean</span> flag = b.enter();</span><br><span class="line">            System.out.println(<span class="string">"Entered barrier: "</span> + args[<span class="number">2</span>]);</span><br><span class="line">            <span class="keyword">if</span>(!flag) System.out.println(<span class="string">"Error when entering the barrier"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException e)&#123;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate random integer</span></span><br><span class="line">        Random rand = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">int</span> r = rand.nextInt(<span class="number">100</span>);</span><br><span class="line">        <span class="comment">// Loop for rand iterations</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; r; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            b.leave();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException e)&#123;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Left barrier"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="3-ZooKeeper-Recipes-and-Solutions"><a href="#3-ZooKeeper-Recipes-and-Solutions" class="headerlink" title="3. ZooKeeper Recipes and Solutions"></a>3. ZooKeeper Recipes and Solutions</h2><p><center> <strong>A Guide to Creating Higher-level Constructs with ZooKeeper</strong>  </center></p>
<p>本节介绍使用ZooKeeper实现更高阶函数。它们都是在客户端实现实现的约定，不需要ZooKeeper的特殊支持。希望社区能够在客户端库中支持这些约定，以简化使用，并鼓励标准化。<br>关于ZooKeeper最有趣的一点是，即使ZooKeeper使用异步通知，您也可以使用它来构建同步一致性原语，比如队列和锁。之所以能做到这一点是因为ZooKeeper对更新强制赋予了一个整体顺序，并且有公开这个顺序的机制。<br>注意，本节的介绍尝试采用最佳的实践。特别是，它们避免轮询、定时器或任何会导致<code>羊群效应(herd effect)</code>的东西，因为这会导致流量激增，限制可伸缩性。<br>可以想象，有许多有用的函数没有包含在这里——例如revocable read-write priority locks。这里提到的一些构造，尤其是锁，主要是说明一些关键点，即使您可能会发现其他构造(如事件句柄或队列)是执行相同功能的更实用的方法。一般来说，本节中的示例旨在激发思考。</p>
<h3 id="3-1-Out-of-the-Box-Applications-Name-Service-Configuration-Group-Membership"><a href="#3-1-Out-of-the-Box-Applications-Name-Service-Configuration-Group-Membership" class="headerlink" title="3.1 Out of the Box Applications: Name Service, Configuration, Group Membership"></a>3.1 Out of the Box Applications: Name Service, Configuration, Group Membership</h3><p><code>Name Service</code>和<code>Configuration</code>是ZooKeeper的两个主要应用。这两个函数由ZooKeeper API直接提供。<br>ZooKeeper直接提供的另一个功能是<code>group membership</code>。<code>group</code>由一个节点表示。组的成员在组节点下创建临时节点。当ZooKeeper检测到异常的成员时，将自动删除它对应的节点。    </p>
<h3 id="3-2-Barriers"><a href="#3-2-Barriers" class="headerlink" title="3.2 Barriers"></a>3.2 Barriers</h3><p>分布式系统使用barriers来阻塞对一组节点的处理，直到满足允许所有节点继续处理的条件为止。barrier在ZooKeeper中通过指定barrier节点来实现。如果barrier node 存在，那么barrier就是存在的。下面是伪代码:</p>
<pre><code>1. Client calls the ZooKeeper API&apos;s exists() function on the barrier node, with watch set to true.
2. If exists() returns false, the barrier is gone and the client proceeds
3. Else, if exists() returns true, the clients wait for a watch event from ZooKeeper for the barrier node.
4. When the watch event is triggered, the client reissues the exists( ) call, again waiting until the barrier node is removed.
</code></pre><h4 id="3-2-1-Double-Barriers"><a href="#3-2-1-Double-Barriers" class="headerlink" title="3.2.1 Double Barriers"></a>3.2.1 Double Barriers</h4><p>double barrier使客户端能够同步计算的开始和结束。当有足够多的进程加入barrier时，进程开始计算并在完成后离开barrier。这一节展示了如何使用ZooKeeper节点作为barrier。<br>伪代码将barrier节点表示为<code>b</code>。每个客户机进程<code>p</code>在进入barrier节点时注册，准备离开时注销。节点通过下面的<code>Enter</code>过程向<code>barrier</code>节点注册，它一直等到客户机<code>x</code>进程注册之后才继续进行计算。  </p>
<table>
<thead>
<tr>
<th style="text-align:center">Enter</th>
<th style="text-align:center">Leave</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1. Create a name n_ = b+“/”+_p</td>
<td style="text-align:center">1. L = getChildren(b, false)</td>
</tr>
<tr>
<td style="text-align:center">2. Set watch: exists(_b_ + ‘‘/ready’’, true)</td>
<td style="text-align:center">2. if no children, exit</td>
</tr>
<tr>
<td style="text-align:center">3. Create child: create(_n_, EPHEMERAL)</td>
<td style="text-align:center">3. if p is only process node in L, delete(n) and exit</td>
</tr>
<tr>
<td style="text-align:center">4. L = getChildren(b, false)</td>
<td style="text-align:center">4. if p is the lowest process node in L, wait on highest process node in L</td>
</tr>
<tr>
<td style="text-align:center">5. if fewer children in L than_x_, wait for watch event</td>
<td style="text-align:center">5. else delete(_n_)if still exists and wait on lowest process node in L</td>
</tr>
<tr>
<td style="text-align:center">6. else create(b + ‘‘/ready’’, REGULAR)</td>
<td style="text-align:center">6. goto 1</td>
</tr>
</tbody>
</table>
<p>在进入时，所有进程都监视一个就绪节点，并创建一个临时节点作为barrier node的子节点。除了最后一个进程之外，其他进程都进入barrier，等待就绪节点出现。创建第x个节点(最后一个进程)的进程将在子列表中看到x个节点，并创建就绪节点，唤醒其他进程。注意，等待进程只有在退出时才会唤醒，因此等待是有效的。<br>在退出时，您不能使用<code>ready</code>之类的标志，因为您正在观察进程节点是否消失。通过使用临时节点，在进入barrier之后失败的进程不会阻止正确的进程完成。当进程准备离开时，它们需要删除自己的流程节点，并等待所有其他进程也这样做。<br>当没有进程节点作为<code>b</code>的子节点时，进程退出。但是，为了提高效率，可以使用最低的流程节点作为就绪标志。准备退出监视的所有其他进程都将离开，以监视现有最低级流程节点，而最低级流程的所有者将监视任何其他流程节点(为了简单起见，选择最高级)。这意味着除了最后一个节点之外，在每个节点删除时只有一个进程会唤醒其他进程，最后一个节点在删除时唤醒所有进程。  </p>
<h3 id="3-3-Queues"><a href="#3-3-Queues" class="headerlink" title="3.3 Queues"></a>3.3 Queues</h3><p>分布式队列是一种常见的数据结构。要在ZooKeeper中实现分布式队列，首先指定一个znode来保存队列，即队列节点。分布式客户机通过调用<code>create()</code>将元素放入队列，路径名以“queue-”结尾，<code>create()</code>调用中的<code>sequence</code>和<code>ephemeral</code>设置为true。由于设置了<code>sequence</code>，新的路径名将具有<code>path-to-queue-node/queue-X</code>的形式，其中<code>X</code>是一个单调递增的数字。想要从队列中删除元素的客户机调用ZooKeeper的<code>getChildren()</code>函数，在队列节点上的watch设置为true，并从处理拥有最小数值的节点开始。客户端不需要发出另一个<code>getChildren()</code>，直到它耗尽从第一个<code>getChildren()</code>调用获得的列表。如果队列节点中没有子节点，则读取器等待一个watch通知来再次检查队列。  </p>
<blockquote>
<p>Note: There now exists a Queue implementation in ZooKeeper recipes directory. This is distributed with the release – zookeeper-recipes/zookeeper-recipes-queue directory of the release artifact.</p>
</blockquote>
<h4 id="3-3-1-Priority-Queues"><a href="#3-3-1-Priority-Queues" class="headerlink" title="3.3.1 Priority Queues"></a>3.3.1 Priority Queues</h4><p>要实现优先队列，只需对通用队列做两个简单的更改。首先，要向队列添加元素，路径名要以“queue-YY”结尾，其中<code>YY</code>是元素的优先级，较小的数值代表较高的优先级(就像UNIX一样)。其次，当从队列中删除元素时，客户机使用最新的子列表，这意味着如果队列节点触发<code>watch</code>，客户机将使以前获得的子列表失效。  </p>
<h3 id="3-4-Locks"><a href="#3-4-Locks" class="headerlink" title="3.4 Locks"></a>3.4 Locks</h3><p>全局同步的完全分布式锁意味着在任何快照中都不会同时有两个客户机认为它们持有相同的锁。这些可以使用ZooKeeeper实现。与优先级队列一样，首先定义一个锁节点。   </p>
<blockquote>
<p>Note: There now exists a Lock implementation in ZooKeeper recipes directory. This is distributed with the release – zookeeper-recipes/zookeeper-recipes-lock directory of the release artifact.</p>
</blockquote>
<p>客户端要获得锁需要：</p>
<ul>
<li>Call create( ) with a pathname of “<em>locknode</em>/guid-lock-“ and the sequence and ephemeral flags set. The guid is needed in case the create() result is missed. See the note below.</li>
<li>Call getChildren( ) on the lock node without setting the watch flag (this is important to avoid the herd effect).</li>
<li>If the pathname created in step 1 has the lowest sequence number suffix, the client has the lock and the client exits the protocol.</li>
<li>The client calls exists( ) with the watch flag set on the path in the lock directory with the next lowest sequence number.</li>
<li>if exists( ) returns null, go to step 2. Otherwise, wait for a notification for the pathname from the previous step before going to step 2.</li>
</ul>
<p>unlock非常简单:希望释放锁的客户机只需删除他们在步骤1中创建的节点。<br>需要注意一些事项：  </p>
<ul>
<li>The removal of a node will only cause one client to wake up since each node is watched by exactly one client. In this way, you avoid the herd effect.</li>
<li>There is no polling or timeouts.</li>
<li>Because of the way you implement locking, it is easy to see the amount of lock contention, break locks, debug locking problems, etc.</li>
</ul>
<h4 id="3-4-1-Shared-Locks"><a href="#3-4-1-Shared-Locks" class="headerlink" title="3.4.1 Shared Locks"></a>3.4.1 Shared Locks</h4><p>You can implement shared locks by with a few changes to the lock protocol:</p>
<table>
<thead>
<tr>
<th style="text-align:center">Obtaining a read lock:</th>
<th style="text-align:center">Obtaining a write lock:</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1. Call create( ) to create a node with pathname “<em>guid-/read-</em>“. This is the lock node use later in the protocol. Make sure to set both the sequence and ephemeral flags.</td>
<td style="text-align:center">1. Call create( ) to create a node with pathname “<em>guid-/write-</em>“. This is the lock node spoken of later in the protocol. Make sure to set both sequence and ephemeral flags.</td>
</tr>
<tr>
<td style="text-align:center">2. Call getChildren( ) on the lock node without setting the watch flag - this is important, as it avoids the herd effect.</td>
<td style="text-align:center">2. Call getChildren( ) on the lock node without setting the watch flag - this is important, as it avoids the herd effect.</td>
</tr>
<tr>
<td style="text-align:center">3. If there are no children with a pathname starting with “<em>write-</em>“ and having a lower sequence number than the node created in step 1, the client has the lock and can exit the protocol.</td>
<td style="text-align:center">3. If there are no children with a lower sequence number than the node created in step 1, the client has the lock and the client exits the protocol.</td>
</tr>
<tr>
<td style="text-align:center">4. Otherwise, call exists( ), with watch flag, set on the node in lock directory with pathname staring with “<em>write-</em>“ having the next lowest sequence number.</td>
<td style="text-align:center">4. Call exists( ), with watch flag set, on the node with the pathname that has the next lowest sequence number.</td>
</tr>
<tr>
<td style="text-align:center">5. If exists( ) returns false, goto step 2.</td>
<td style="text-align:center">5. If exists( ) returns false, goto step 2. Otherwise, wait for a notification for the pathname from the previous step before going to step 2.</td>
</tr>
<tr>
<td style="text-align:center">6. Otherwise, wait for a notification for the pathname from the previous step before going to step 2</td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<blockquote>
<p>Notes: It might appear that this recipe creates a <code>herd effect</code>: when there is a large group of clients waiting for a read lock, and all getting notified more or less simultaneously when the “<em>write-</em>“ node with the lowest sequence number is deleted. In fact. that’s valid behavior: as all those waiting reader clients should be released since they have the lock. The herd effect refers to releasing a “herd” when in fact only a single or a small number of machines can proceed.   </p>
</blockquote>
<h4 id="3-4-2-Revocable-Shared-Locks"><a href="#3-4-2-Revocable-Shared-Locks" class="headerlink" title="3.4.2 Revocable Shared Locks"></a>3.4.2 Revocable Shared Locks</h4><p>With minor modifications to the Shared Lock protocol, you make shared locks revocable by modifying the shared lock protocol:<br>In step 1, of both obtain reader and writer lock protocols, call getData( ) with watch set, immediately after the call to create( ). If the client subsequently receives notification for the node it created in step 1, it does another getData( ) on that node, with watch set and looks for the string “unlock”, which signals to the client that it must release the lock. This is because, according to this shared lock protocol, you can request the client with the lock give up the lock by calling setData() on the lock node, writing “unlock” to that node.<br>Note that this protocol requires the lock holder to consent to releasing the lock. Such consent is important, especially if the lock holder needs to do some processing before releasing the lock. Of course you can always implement Revocable Shared Locks with Freaking Laser Beams by stipulating in your protocol that the revoker is allowed to delete the lock node if after some length of time the lock isn’t deleted by the lock holder.</p>
<h3 id="3-5-Two-phased-Commit"><a href="#3-5-Two-phased-Commit" class="headerlink" title="3.5 Two-phased Commit"></a>3.5 Two-phased Commit</h3><p>两阶段提交协议是一种算法，它允许分布式系统中的所有客户端同意提交事务或中止事务。<br>In ZooKeeper, you can implement a two-phased commit by having a coordinator create a transaction node, say “/app/Tx”, and one child node per participating site, say “/app/Tx/s_i”. When coordinator creates the child node, it leaves the content undefined. Once each site involved in the transaction receives the transaction from the coordinator, the site reads each child node and sets a watch. Each site then processes the query and votes “commit” or “abort” by writing to its respective node. Once the write completes, the other sites are notified, and as soon as all sites have all votes, they can decide either “abort” or “commit”. Note that a node can decide “abort” earlier if some site votes for “abort”.<br>An interesting aspect of this implementation is that the only role of the coordinator is to decide upon the group of sites, to create the ZooKeeper nodes, and to propagate the transaction to the corresponding sites. In fact, even propagating the transaction can be done through ZooKeeper by writing it in the transaction node.<br>There are two important drawbacks of the approach described above. One is the message complexity, which is O(n²). The second is the impossibility of detecting failures of sites through ephemeral nodes. To detect the failure of a site using ephemeral nodes, it is necessary that the site create the node.<br>To solve the first problem, you can have only the coordinator notified of changes to the transaction nodes, and then notify the sites once coordinator reaches a decision. Note that this approach is scalable, but it’s is slower too, as it requires all communication to go through the coordinator.<br>To address the second problem, you can have the coordinator propagate the transaction to the sites, and have each site creating its own ephemeral node.  </p>
<h3 id="3-6-Leader-Election"><a href="#3-6-Leader-Election" class="headerlink" title="3.6 Leader Election"></a>3.6 Leader Election</h3>
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/zookeeper/" rel="tag"># zookeeper</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/26/backends/zookeeper/ZooKeeper(三) ZooKeeper Programmer's Guide/" rel="next" title="ZooKeeper(三) ZooKeeper Programmer's Guide">
                <i class="fa fa-chevron-left"></i> ZooKeeper(三) ZooKeeper Programmer's Guide
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/29/backends/zookeeper/ZooKeeper(五) 分布式锁及ZooKeeper实现/" rel="prev" title="ZooKeeper(五) 分布式锁的实现总结及ZooKeeper实现">
                ZooKeeper(五) 分布式锁的实现总结及ZooKeeper实现 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.gif" alt="Javior Wang">
            
              <p class="site-author-name" itemprop="name">Javior Wang</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/scorego" title="GitHub &rarr; https://github.com/scorego" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.zhihu.com/people/scorego-6" title="Zhihu &rarr; https://www.zhihu.com/people/scorego-6" rel="noopener" target="_blank"><i class="fa fa-fw fa-heartbeat"></i>Zhihu</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-ZooKeeper-Java-Example"><span class="nav-text">1. ZooKeeper Java Example</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-The-Executor-Class"><span class="nav-text">1.1 The Executor Class</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-The-DataMonitor-Class"><span class="nav-text">1.2 The DataMonitor Class</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-Complete-Source-Listings"><span class="nav-text">1.3 Complete Source Listings</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Programming-with-ZooKeeper-A-basic-tutorial"><span class="nav-text">2. Programming with ZooKeeper - A basic tutorial</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Barriers"><span class="nav-text">2.1 Barriers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Producer-Consumer-Queues"><span class="nav-text">2.2 Producer-Consumer Queues</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-Complete-example"><span class="nav-text">2.3 Complete example</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-Queue-test"><span class="nav-text">2.3.1 Queue test</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-Barrier-test"><span class="nav-text">2.3.2 Barrier test</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-Source-Listing"><span class="nav-text">2.3.3 Source Listing</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-ZooKeeper-Recipes-and-Solutions"><span class="nav-text">3. ZooKeeper Recipes and Solutions</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Out-of-the-Box-Applications-Name-Service-Configuration-Group-Membership"><span class="nav-text">3.1 Out of the Box Applications: Name Service, Configuration, Group Membership</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-Barriers"><span class="nav-text">3.2 Barriers</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-Double-Barriers"><span class="nav-text">3.2.1 Double Barriers</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-Queues"><span class="nav-text">3.3 Queues</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-1-Priority-Queues"><span class="nav-text">3.3.1 Priority Queues</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-Locks"><span class="nav-text">3.4 Locks</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-1-Shared-Locks"><span class="nav-text">3.4.1 Shared Locks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-2-Revocable-Shared-Locks"><span class="nav-text">3.4.2 Revocable Shared Locks</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-Two-phased-Commit"><span class="nav-text">3.5 Two-phased Commit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-Leader-Election"><span class="nav-text">3.6 Leader Election</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Javior Wang</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.0"></script>




  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
